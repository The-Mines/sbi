# Dockerfile for Node.js 22 LTS Development image based on Wolfi
# This builds a container image with development tools for Node.js 22 LTS applications

FROM cgr.dev/chainguard/wolfi-base:latest

# Start as root user for installation and setup
USER root

# Set up environment variables
ENV NODE_VERSION=22
ENV NODE_PORT=3000
ENV NPM_CONFIG_UPDATE_NOTIFIER=false
ENV PATH=/usr/sbin:/sbin:/usr/bin:/bin

# Install Node.js 22 LTS and required packages, including development tools
# Deliberately avoid busybox to minimize attack surface
RUN apk update && \
    apk add --no-cache \
    nodejs-22 \
    npm \
    yarn \
    corepack \
    pnpm \
    build-base \
    dumb-init \
    nghttp2

# Create a non-root user and group
# Let the system choose available IDs instead of hardcoding
RUN addgroup -S node && \
    adduser -S -G node -h /home/node node

# Create application directory and set permissions
RUN mkdir -p /app && \
    chown -R node:node /app && \
    chmod 755 /app

# Set working directory
WORKDIR /app

# Switch to non-root user
USER node

# Set entrypoint and default command
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["/usr/bin/node", "--help"]

# Define metadata
LABEL org.opencontainers.image.title="Node.js 22 LTS Development"
LABEL org.opencontainers.image.description="Container image with development tools for Node.js 22 LTS apps"
LABEL org.opencontainers.image.vendor="The Mines"
LABEL org.opencontainers.image.source="https://github.com/The-Mines/sbi"
LABEL org.opencontainers.image.documentation="https://github.com/The-Mines/sbi/blob/main/containers/node/node22/README.md"