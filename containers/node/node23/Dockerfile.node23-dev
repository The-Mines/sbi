# Dockerfile for Node.js 23 Development image based on Wolfi
# This builds a container image with development tools for Node.js 23 applications

FROM cgr.dev/chainguard/wolfi-base:latest

# Install Node.js 23 and development tools
RUN apk update && \
    apk add --no-cache \
    nodejs-23 \
    npm \
    yarn \
    pnpm \
    git \
    build-base \
    python3 \
    curl \
    dumb-init \
    nghttp2

# Create a non-root user for running the application
RUN addgroup -S node && \
    adduser -S -G node -h /home/node node

# Set environment variables
ENV NODE_PORT=3000
ENV NPM_CONFIG_UPDATE_NOTIFIER=false
ENV PATH=$PATH:/usr/local/bin:/home/node/.npm/bin

# Create and set permissions for app directory
RUN mkdir -p /app && \
    chown -R node:node /app && \
    chmod 755 /app

# Create global npm directory for the node user
RUN mkdir -p /home/node/.npm && \
    chown -R node:node /home/node/.npm

# Set working directory
WORKDIR /app

# Switch to non-root user
USER node

# Use dumb-init as entrypoint to handle signals properly
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Default command
CMD ["node", "--version"]

# Define metadata
LABEL org.opencontainers.image.title="Node.js 23 Development"
LABEL org.opencontainers.image.description="Container image with development tools for Node.js 23 apps"
LABEL org.opencontainers.image.vendor="The Mines"
LABEL org.opencontainers.image.source="https://github.com/The-Mines/sbi"
LABEL org.opencontainers.image.documentation="https://github.com/The-Mines/sbi/blob/main/containers/node/node23/README.md"