# Start from scratch to mimic distroless/minimal base
FROM scratch

# Copy over root filesystem generated by apko
COPY rootfs/ /

# Set environment variables for PostgreSQL
ENV PGDATA=/var/lib/postgresql/data \
    POSTGRES_USER=postgres \
    POSTGRES_PASSWORD=postgres \
    POSTGRES_DB=postgres

# Create directories with proper permissions
RUN mkdir -p "$PGDATA" && chown -R nonroot:nonroot "$PGDATA" && chmod 700 "$PGDATA"

# Set working directory to where PostgreSQL data will be stored
WORKDIR /var/lib/postgresql

# Set default shell
SHELL ["/bin/sh", "-c"]

# Use the PostgreSQL entrypoint
ENTRYPOINT ["/usr/libexec/postgresql-oci-entrypoint"]

# Default command
CMD ["postgres"]

# Expose PostgreSQL default port
EXPOSE 5432

# Set user to nonroot for better security
USER nonroot